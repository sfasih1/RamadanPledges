<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Ramadan Pledges</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
      * { box-sizing: border-box; }
      body { 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
        max-width: 700px; 
        margin: 0 auto; 
        padding: 2rem 1rem; 
        line-height: 1.6;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }
      h1 { 
        color: #764ba2; 
        margin-top: 0;
        text-align: center;
      }
      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }
      .info-box { 
        background: #f0f4ff; 
        padding: 1rem; 
        border-radius: 0.5rem; 
        margin-bottom: 2rem;
        border-left: 4px solid #667eea;
      }
      .unit-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #fafafa;
        border-radius: 0.5rem;
      }
      .unit-item { text-align: center; }
      .unit-item strong { display: block; color: #667eea; font-size: 1.3rem; }
      .unit-item small { color: #999; }
      label { 
        display: block; 
        margin-top: 1.2rem; 
        margin-bottom: 0.4rem;
        font-weight: 600; 
        color: #333;
      }
      input, select, button { 
        font-size: 1rem; 
        padding: 0.75rem; 
        width: 100%; 
        margin-top: 0.35rem;
        border: 1px solid #ddd;
        border-radius: 0.4rem;
        font-family: inherit;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #667eea;
        background: #f9f9ff;
      }
      button { 
        cursor: pointer; 
        background: #667eea;
        color: white;
        border: none;
        font-weight: 600;
        margin-top: 1.5rem;
        transition: background 0.3s;
      }
      button:hover { 
        background: #764ba2; 
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 1rem; 
      }
      .total-amount {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #764ba2;
        margin: 1.5rem 0;
        padding: 1rem;
        background: #f0f4ff;
        border-radius: 0.5rem;
      }
      .error { color: #d32f2f; font-size: 0.95rem; margin-top: 0.3rem; }
      .loading { display: none; text-align: center; margin-top: 1rem; }
      button:disabled .loading { display: inline; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸŒ™ Ramadan Pledges</h1>
      <p class="subtitle">Make Your Blessed Donation</p>
      
      <div class="info-box">
        <strong>Available Units:</strong> {units_available} out of 80 remain
      </div>

      <div class="unit-info">
        <div class="unit-item">
          <strong>$1,000</strong>
          <small>per unit</small>
        </div>
        <div class="unit-item">
          <strong>80</strong>
          <small>total units</small>
        </div>
      </div>

      <form id="pledge-form">
        <label for="units">Number of Units</label>
        <input id="units" name="units" type="number" min="1" max="80" value="1" required/>
        <span class="error" id="units-error"></span>

        <label for="donor-name">Your Name</label>
        <input id="donor-name" name="donor_name" type="text" placeholder="Enter your name" />

        <label for="donor-email">Email Address</label>
        <input id="donor-email" name="donor_email" type="email" placeholder="your@email.com" />

        <div class="row">
          <div>
            <label for="frequency">Payment Frequency</label>
            <select id="frequency" name="frequency">
              <option value="once">Pay All at Once</option>
              <option value="weekly">Pay Weekly</option>
              <option value="monthly">Pay Monthly</option>
            </select>
          </div>
          <div>
            <label for="currency">Currency</label>
            <select id="currency" name="currency">
              <option value="usd">USD</option>
              <option value="gbp">GBP</option>
              <option value="eur">EUR</option>
              <option value="aed">AED</option>
            </select>
          </div>
        </div>

        <div id="duration-wrapper" style="display: none;">
          <label for="duration">Payment Duration</label>
          <select id="duration" name="duration">
            <!-- Options populated by JavaScript -->
          </select>
        </div>

        <div class="total-amount" id="total-display">Total: $1,000.00</div>

        <button type="submit">Proceed to Checkout</button>
      </form>
    </div>

    <script>
      const unitsInput = document.getElementById('units');
      const totalDisplay = document.getElementById('total-display');
      const form = document.getElementById('pledge-form');
      const unitsError = document.getElementById('units-error');
      const frequencySelect = document.getElementById('frequency');
      const durationSelect = document.getElementById('duration');
      const durationWrapper = document.getElementById('duration-wrapper');
      const currencySelect = document.getElementById('currency');

      const UNIT_PRICE = 1000;

      // Populate duration options based on frequency
      function populateDurationOptions() {
        const frequency = frequencySelect.value;
        durationSelect.innerHTML = '';

        if (frequency === 'weekly') {
          for (let i = 1; i <= 26; i++) {
            const weeks = i;
            const months = (weeks / 4.33).toFixed(1);
            const option = document.createElement('option');
            option.value = i;
            option.text = `${i} week${i > 1 ? 's' : ''} (~${months} months)`;
            durationSelect.appendChild(option);
          }
          durationWrapper.style.display = 'block';
        } else if (frequency === 'monthly') {
          for (let i = 1; i <= 6; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = `${i} month${i > 1 ? 's' : ''}`;
            durationSelect.appendChild(option);
          }
          durationWrapper.style.display = 'block';
        } else {
          durationWrapper.style.display = 'none';
        }
      }

      // Update total when units, frequency, duration, or currency change
      function updateTotal() {
        const units = parseInt(unitsInput.value) || 0;
        const frequency = frequencySelect.value;
        const duration = parseInt(durationSelect.value) || 1;
        
        if (units < 1 || units > 80) {
          unitsError.textContent = 'Units must be between 1 and 80';
          return;
        }
        unitsError.textContent = '';
        
        let baseTotal = units * UNIT_PRICE;
        let displayTotal = baseTotal;
        let totalText = '';
        
        if (frequency === 'once') {
          totalText = `Total: ${currencySelect.value.toUpperCase()} ${baseTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        } else if (frequency === 'weekly') {
          displayTotal = baseTotal * duration;
          totalText = `Total: ${currencySelect.value.toUpperCase()} ${baseTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} x ${duration} weeks = ${currencySelect.value.toUpperCase()} ${displayTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        } else if (frequency === 'monthly') {
          displayTotal = baseTotal * duration;
          totalText = `Total: ${currencySelect.value.toUpperCase()} ${baseTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} x ${duration} months = ${currencySelect.value.toUpperCase()} ${displayTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        totalDisplay.textContent = totalText;
      }

      unitsInput.addEventListener('change', updateTotal);
      unitsInput.addEventListener('input', updateTotal);
      frequencySelect.addEventListener('change', () => {
        populateDurationOptions();
        updateTotal();
      });
      durationSelect.addEventListener('change', updateTotal);
      currencySelect.addEventListener('change', updateTotal);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const units = parseInt(unitsInput.value);
        if (units < 1 || units > 80) {
          alert('Units must be between 1 and 80');
          return;
        }

        const button = e.target.querySelector('button');
        button.disabled = true;
        button.textContent = 'Processing...';

        const frequency = frequencySelect.value;
        const duration = frequency !== 'once' ? parseInt(durationSelect.value) : 1;

        const payload = {
          units: units,
          frequency: frequency,
          duration: duration,
          currency: currencySelect.value,
          donor_name: document.getElementById('donor-name').value || 'Anonymous',
          donor_email: document.getElementById('donor-email').value
        };

        try {
          const res = await fetch('/create-checkout-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          window.location = data.url;
        } catch (err) {
          alert(err.message || 'Failed to start checkout.');
          button.disabled = false;
          button.textContent = 'Proceed to Checkout';
        }
      });

      // Initialize display
      populateDurationOptions();
      updateTotal();
    </script>
  </body>
</html>
